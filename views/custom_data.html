{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    {% if message %}
    <div class="alert alert-{{ message.type }} alert-dismissible fade show" role="alert">
        {{ message.text }}
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
    {% endif %}

    <div class="row mb-4">
        <div class="col-12">
            <div class="card bg-primary text-white">
                <div class="card-body">
                    <h2 class="card-title"><i class="fas fa-database me-2"></i>Gerenciador de Dados Personalizados</h2>
                    <p class="card-text">Adicione, visualize e gerencie seus dados personalizados de forma simples e eficiente.</p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <!-- Seção de Lista -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-list me-2"></i>Lista Simples</h5>
                    <form method="POST" action="{{ url_for('clear_custom_data', data_type='list') }}" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-sm" 
                                onclick="return confirm('Tem certeza que deseja limpar toda a lista?')">
                            <i class="fas fa-trash-alt me-2"></i>Limpar Lista
                        </button>
                    </form>
                </div>
                <div class="card-body">
                    <!-- Formulário de Lista -->
                    <form method="POST" class="mb-4">
                        <div class="input-group">
                            <input type="text" class="form-control" name="list_item" placeholder="Digite um item para a lista..." required>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-plus-circle me-2"></i>Adicionar
                            </button>
                        </div>
                    </form>

                    <!-- Lista de Itens -->
                    {% if custom_list %}
                    <div class="list-group list-group-flush">
                        {% for item in custom_list %}
                        <div class="list-group-item list-group-item-action d-flex justify-content-between align-items-center">
                            <span class="item-text">{{ item }}</span>
                            <div class="btn-group">
                                <button class="btn btn-outline-primary btn-sm edit-item" data-item="{{ item }}" data-index="{{ loop.index0 }}">
                                    <i class="fas fa-edit"></i>
                                </button>
                                <a href="{{ url_for('remove_item', data_type='list', index=loop.index0) }}" 
                                   class="btn btn-outline-danger btn-sm"
                                   onclick="return confirm('Tem certeza que deseja remover este item?')">
                                    <i class="fas fa-times"></i>
                                </a>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div class="mt-3 text-end">
                        <span class="badge bg-secondary">Total: {{ custom_list|length }} item(s)</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted my-5 py-5">
                        <i class="fas fa-list fa-3x mb-3"></i>
                        <p>Nenhum item na lista ainda.</p>
                        <p class="small">Adicione itens usando o formulário acima.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Seção de Dicionário -->
        <div class="col-md-6 mb-4">
            <div class="card shadow-sm">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-code me-2"></i>Dicionário de Dados</h5>
                    <form method="POST" action="{{ url_for('clear_custom_data', data_type='dict') }}" class="d-inline">
                        <button type="submit" class="btn btn-danger btn-sm"
                                onclick="return confirm('Tem certeza que deseja limpar todo o dicionário?')">
                            <i class="fas fa-trash-alt me-2"></i>Limpar Dicionário
                        </button>
                    </form>
                </div>
                <div class="card-body">
                    <!-- Formulário de Dicionário -->
                    <form method="POST" class="mb-4" id="jsonForm">
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-info-circle me-2"></i>
                                Adicione dados em formato JSON
                            </label>
                            <div class="d-flex mb-2">
                                <div class="dropdown me-2">
                                    <button class="btn btn-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                                        <i class="fas fa-file-code me-1"></i> Modelos
                                    </button>
                                    <ul class="dropdown-menu">
                                        <li><a class="dropdown-item" href="#" onclick="setTemplate('pessoa')">Pessoa</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setTemplate('produto')">Produto</a></li>
                                        <li><a class="dropdown-item" href="#" onclick="setTemplate('evento')">Evento</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item" href="#" onclick="setTemplate('astronauta')">Astronauta</a></li>
                                    </ul>
                                </div>
                                <button type="button" class="btn btn-outline-secondary" onclick="formatJson()">
                                    <i class="fas fa-align-left me-1"></i> Formatar JSON
                                </button>
                            </div>
                            <textarea class="form-control" id="json_data" name="json_data" rows="8" required></textarea>
                            <div id="jsonValidationMessage" class="form-text mt-1"></div>
                        </div>
                        <button type="submit" class="btn btn-primary" id="submitJsonBtn">
                            <i class="fas fa-plus-circle me-2"></i>Adicionar ao Dicionário
                        </button>
                    </form>

                    <!-- Tabela de Dicionários -->
                    {% if custom_dict %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th>#</th>
                                    <th>Dados</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for item in custom_dict %}
                                <tr>
                                    <td>{{ loop.index }}</td>
                                    <td>
                                        <pre class="mb-0 json-display"><code>{{ item | tojson(indent=2) }}</code></pre>
                                    </td>
                                    <td>
                                        <div class="btn-group">
                                            <button class="btn btn-outline-primary btn-sm edit-json" 
                                                    data-json='{{ item | tojson }}' 
                                                    data-index="{{ loop.index0 }}">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                            <a href="{{ url_for('remove_item', data_type='dict', index=loop.index0) }}" 
                                               class="btn btn-outline-danger btn-sm"
                                               onclick="return confirm('Tem certeza que deseja remover este item?')">
                                                <i class="fas fa-times"></i>
                                            </a>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    <div class="mt-3 text-end">
                        <span class="badge bg-secondary">Total: {{ custom_dict|length }} item(s)</span>
                    </div>
                    {% else %}
                    <div class="text-center text-muted my-5 py-5">
                        <i class="fas fa-code fa-3x mb-3"></i>
                        <p>Nenhum dicionário adicionado ainda.</p>
                        <p class="small">Adicione dados JSON usando o formulário acima.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal para edição de item da lista -->
<div class="modal fade" id="editItemModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar Item</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editItemForm" method="POST" action="{{ url_for('custom_data_page') }}">
                <div class="modal-body">
                    <input type="hidden" name="edit_type" value="list">
                    <input type="hidden" name="edit_index" id="editItemIndex">
                    <div class="mb-3">
                        <label for="editItemValue" class="form-label">Item</label>
                        <input type="text" class="form-control" id="editItemValue" name="edit_value" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Modal para edição de JSON -->
<div class="modal fade" id="editJsonModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Editar JSON</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="editJsonForm" method="POST" action="{{ url_for('custom_data_page') }}">
                <div class="modal-body">
                    <input type="hidden" name="edit_type" value="dict">
                    <input type="hidden" name="edit_index" id="editJsonIndex">
                    <div class="mb-3">
                        <button type="button" class="btn btn-outline-secondary btn-sm mb-2" onclick="formatEditJson()">
                            <i class="fas fa-align-left me-1"></i> Formatar JSON
                        </button>
                        <textarea class="form-control" id="editJsonValue" name="edit_value" rows="10" required></textarea>
                        <div id="editJsonValidationMessage" class="form-text mt-1"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="submit" class="btn btn-primary" id="saveJsonBtn">Salvar</button>
                </div>
            </form>
        </div>
    </div>
</div>

<style>
.json-display {
    background-color: #f8f9fa;
    border-radius: 4px;
    padding: 10px;
    max-height: 200px;
    overflow-y: auto;
}

.card {
    transition: transform 0.2s;
}

.card:hover {
    transform: translateY(-5px);
}

.list-group-item:hover {
    background-color: #f8f9fa;
}

#json_data, #editJsonValue {
    font-family: monospace;
}
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Formata o JSON no textarea quando colado
    document.getElementById('json_data').addEventListener('paste', function(e) {
        setTimeout(() => {
            try {
                const json = JSON.parse(this.value);
                this.value = JSON.stringify(json, null, 4);
                validateJson(this.value);
            } catch (e) {
                // Se não for JSON válido, mantém o texto original
            }
        }, 0);
    });

    // Validação de JSON em tempo real
    document.getElementById('json_data').addEventListener('input', function() {
        validateJson(this.value);
    });

    // Validação de JSON de edição em tempo real
    document.getElementById('editJsonValue').addEventListener('input', function() {
        validateEditJson(this.value);
    });

    // Configurar modal de edição de item
    const editItemModal = new bootstrap.Modal(document.getElementById('editItemModal'));
    document.querySelectorAll('.edit-item').forEach(button => {
        button.addEventListener('click', function() {
            const item = this.getAttribute('data-item');
            const index = this.getAttribute('data-index');
            document.getElementById('editItemValue').value = item;
            document.getElementById('editItemIndex').value = index;
            editItemModal.show();
        });
    });

    // Configurar modal de edição de JSON
    const editJsonModal = new bootstrap.Modal(document.getElementById('editJsonModal'));
    document.querySelectorAll('.edit-json').forEach(button => {
        button.addEventListener('click', function() {
            const json = JSON.parse(this.getAttribute('data-json'));
            const index = this.getAttribute('data-index');
            document.getElementById('editJsonValue').value = JSON.stringify(json, null, 4);
            document.getElementById('editJsonIndex').value = index;
            validateEditJson(document.getElementById('editJsonValue').value);
            editJsonModal.show();
        });
    });
});

// Templates para facilitar a entrada de dados
const templates = {
    pessoa: {
        nome: "João Silva",
        idade: 30,
        email: "joao@email.com",
        telefone: "(11) 99999-9999"
    },
    produto: {
        nome: "Produto Exemplo",
        preco: 99.99,
        categoria: "Eletrônicos",
        estoque: 50
    },
    evento: {
        titulo: "Evento Exemplo",
        data: "2024-03-20",
        local: "São Paulo",
        participantes: 100
    },
    astronauta: {
        nome: "Robert Behnken",
        agencia: "NASA",
        imagem: "https://i.imgur.com/0smMgMH.png",
        wikipedia: "https://en.wikipedia.org/wiki/Robert_L._Behnken",
        lancamentos: [
            "5eb87d46ffd86e000604b388"
        ],
        status: "ativo",
        id: "5ebf1a6e23a9a60006e03a7a"
    }
};

function setTemplate(type) {
    const textarea = document.getElementById('json_data');
    textarea.value = JSON.stringify(templates[type], null, 4);
    validateJson(textarea.value);
}

function formatJson() {
    const textarea = document.getElementById('json_data');
    try {
        const json = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(json, null, 4);
        validateJson(textarea.value);
    } catch (e) {
        document.getElementById('jsonValidationMessage').innerHTML = 
            '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> JSON inválido: ' + e.message + '</span>';
    }
}

function formatEditJson() {
    const textarea = document.getElementById('editJsonValue');
    try {
        const json = JSON.parse(textarea.value);
        textarea.value = JSON.stringify(json, null, 4);
        validateEditJson(textarea.value);
    } catch (e) {
        document.getElementById('editJsonValidationMessage').innerHTML = 
            '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> JSON inválido: ' + e.message + '</span>';
    }
}

function validateJson(jsonString) {
    const messageElement = document.getElementById('jsonValidationMessage');
    const submitButton = document.getElementById('submitJsonBtn');
    
    if (!jsonString.trim()) {
        messageElement.innerHTML = '';
        submitButton.disabled = true;
        return;
    }
    
    try {
        JSON.parse(jsonString);
        messageElement.innerHTML = 
            '<span class="text-success"><i class="fas fa-check-circle"></i> JSON válido</span>';
        submitButton.disabled = false;
    } catch (e) {
        messageElement.innerHTML = 
            '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> JSON inválido: ' + e.message + '</span>';
        submitButton.disabled = true;
    }
}

function validateEditJson(jsonString) {
    const messageElement = document.getElementById('editJsonValidationMessage');
    const submitButton = document.getElementById('saveJsonBtn');
    
    if (!jsonString.trim()) {
        messageElement.innerHTML = '';
        submitButton.disabled = true;
        return;
    }
    
    try {
        JSON.parse(jsonString);
        messageElement.innerHTML = 
            '<span class="text-success"><i class="fas fa-check-circle"></i> JSON válido</span>';
        submitButton.disabled = false;
    } catch (e) {
        messageElement.innerHTML = 
            '<span class="text-danger"><i class="fas fa-exclamation-triangle"></i> JSON inválido: ' + e.message + '</span>';
        submitButton.disabled = true;
    }
}

// Prevenir envio de formulário com JSON inválido
document.getElementById('jsonForm').addEventListener('submit', function(e) {
    try {
        JSON.parse(document.getElementById('json_data').value);
    } catch (error) {
        e.preventDefault();
        alert('Por favor, corrija o JSON antes de enviar.');
    }
});

// Prevenir envio de formulário de edição com JSON inválido
document.getElementById('editJsonForm').addEventListener('submit', function(e) {
    try {
        JSON.parse(document.getElementById('editJsonValue').value);
    } catch (error) {
        e.preventDefault();
        alert('Por favor, corrija o JSON antes de enviar.');
    }
});
</script>
{% endblock %} 